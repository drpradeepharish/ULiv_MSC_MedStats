"0",""
"0","library(tidyverse)"
"0","library(readxl)"
"0","library(lubridate)"
"0","library(magrittr)"
"0",""
"0","lstCSV <- list.files(path = ""Source/"", pattern = ""\\.csv$"")"
"0",""
"0","for (i in 1:length(lstCSV))"
"0","{"
"0","  assign(substr(lstCSV[i], 1, nchar(lstCSV[i]) - 4), read_csv(file = paste0(""Source/"",lstCSV[i])))"
"0","}"
"2","[1mRows: [22m[34m2651389[39m [1mColumns: [22m[34m50[39m"
"2","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[31mchr[39m (41): pcd, pcd2, pcds, oscty, ced, oslaua, osward, parish, osnrth1m, oshlthau, nhser, ctry, rgn, pcon, eer, teclec, ttwa, ...
[32mdbl[39m  (9): dointr, doterm, usertype, oseast1m, osgrdind, streg, lat, long, imd"
"2","Error: no more error handlers available (recursive errors?); invoking 'abort' restart
"
"2","Warning in stopifnot(is.character(filename), length(filename) == 1L) :"
"2","
 "
"2"," type 29 is unimplemented in 'type2char'
"
"2","Error in stopifnot(is.character(filename), length(filename) == 1L) : 
  INTEGER() can only be applied to a 'integer', not a 'unknown type #29'
"
"2","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message."
"2","[1mRows: [22m[34m476858[39m [1mColumns: [22m[34m10[39m"
"2","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[31mchr[39m  (5): sex, qimd, ethnicity, sha, smoking_status
[32mdbl[39m  (3): pid, medcodeid, snomedctdescriptionid
[34mdate[39m (2): dob, event_date"
"2","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message."
"2","[1mRows: [22m[34m10[39m [1mColumns: [22m[34m2[39m"
"2","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[31mchr[39m (2): SHA10CD, SHA10NM"
"2","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message."
"0","dLungCancerCodes <- read_csv(""https://raw.githubusercontent.com/annalhead/CPRD_multimorbidity_codelists/9d26739d93744c8444aedbe10de65657c4af6bc0/codelists/Primary%20Malignancy_Lung.csv"")"
"2","[1mRows: [22m[34m38[39m [1mColumns: [22m[34m12[39m"
"2","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[31mchr[39m (6): read code, disease, descr, category, system, mapping
[32mdbl[39m (6): medcode, disease_num, system_num, medcodeid, snomedctconceptid, snomedctdescriptionid"
"2","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message."
"0","dPopEstimates20112022 <- read_excel(""Source/myebtablesenglandwales20112022v3.xlsx"", sheet = ""MYEB1 (2023 Geography)"", skip = 1)"
"0",""
"0","ONSPD_NOV_2020_UK %>% "
"0","  select(oslaua,oshlthau) %>% "
"0","  unique() %>% "
"0","  filter(oshlthau %in% SHA_names_and_codes_EN_as_at_12_10$SHA10CD) %>% "
"0","  left_join(SHA_names_and_codes_EN_as_at_12_10, by = (c(""oshlthau"" = ""SHA10CD""))) -> dONSPostcodes "
"0",""
"0","dPopEstimates20112022 %>% left_join(dONSPostcodes, by = c(""ladcode23"" = ""oslaua"")) %>%"
"0","  select(-c(ladcode23, laname23, oshlthau, country)) %>%"
"0","  filter(!is.na(SHA10NM)) %>% "
"0","  group_by(SHA10NM, age, sex) %>% "
"0","  summarise(across(starts_with(""population""),sum)) -> dSumPopEstimates"
"2","`summarise()` has grouped output by 'SHA10NM', 'age'. You can override using the `.groups` argument."
"0","rm(ONSPD_NOV_2020_UK, dPopEstimates20112022, dONSPostcodes, SHA_names_and_codes_EN_as_at_12_10)"
"0",""
"0","intervalStudy <- interval(ymd_hms(""2014-1-1 0:0:1""),ymd_hms(""2020-12-31 23:59:59""))"
"0",""
"0","pop_snomed_assignment %>% "
"0","    mutate(age_at_event = interval(ymd(dob),ymd(event_date)) %/% years(1)) %>%"
"0","    filter(.$snomedctdescriptionid %in% dLungCancerCodes$snomedctdescriptionid) %>%     .$pid %>% "
"0","    unique() -> lstDiagnosedPatients "
"0",""
"0","pop_snomed_assignment %>% "
"0","  mutate(age_at_event = interval(ymd(dob),ymd(event_date)) %/% years(1)) %>% "
"0","  filter(pid %in% lstDiagnosedPatients) %>% "
"0","  mutate(is_cancer_relevant = ifelse(snomedctdescriptionid %in% dLungCancerCodes$snomedctdescriptionid, ""Y"",""N""),"
"0","         is_death = ifelse(snomedctdescriptionid <0,ifelse(snomedctdescriptionid == -5,""C"",""Y""),""N"")) %>% "
"0","  filter(event_date %within% intervalStudy) %>% "
"0","  select(-c(snomedctdescriptionid, medcodeid))-> dDiagnosedPatients"
"0","  "
"0"," # mutate(ageband = case_when("
"0","  #  age <= 18 ~ ""0-18"","
"0","  #  age > 18 & age <= 36 ~ ""18-36"","
"0","  #  age > 36 & age <= 54 ~ ""36-54"","
"0","  #  age > 54 & age <= 72 ~ ""54-72"","
"0","  #  age > 72 & age <= 90 ~ ""72-90"","
"0","  #  `age` > 90 ~ ""90+"""
"0","  #)) "
"0",""
