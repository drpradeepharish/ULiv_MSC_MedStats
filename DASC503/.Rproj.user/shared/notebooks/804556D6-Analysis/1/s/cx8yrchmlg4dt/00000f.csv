"0","# Function to get the most frequently occurring value in a vector. "
"0","fGetMostFrequent <- function(tblInput){"
"0","  tblInput %>% "
"0","    table() %>% "
"0","    sort(decreasing = TRUE) %>% "
"0","    .[1] %>% "
"0","    names() -> output"
"0","  return(output)"
"0","}"
"0",""
"0","# Function to calculate the time difference in years between two dates"
"0","fCalcYear <- function(dateFrom,dateTo){"
"0","  return(interval(dateFrom, dateTo) / years(1))"
"0","}"
"0",""
"0","# Function to save ggPlot"
"0","fSavePlot <-"
"0","  function(plot,"
"0","           title = NA,"
"0","           subtitle = NA,"
"0","           h = 8,"
"0","           w = 12,"
"0","           background = ""white"") {"
"0","    ggsave("
"0","      plot,"
"0","      filename = paste0(title, subtitle, "".png""),"
"0","      path = ""Figures/"","
"0","      device = ""png"","
"0","      dpi = 800,"
"0","      width = w,"
"0","      height = h,"
"0","      units = ""in"","
"0","      bg = background,"
"0","      create.dir = TRUE"
"0","    )"
"0","  }"
"0",""
"0","# Function to calculate incidence and poission CI"
"0","fCalculateIncidence <- function(tblNumerator, tblDenominator, strGroupVars) "
"0","  {"
"0","  tblNumerator %>%"
"0","    group_by(across(all_of(strGroupVars))) %>%"
"0","    summarise(diagnosed = sum(ever_diagnosed)) %>%"
"0","    left_join("
"0","      tblDenominator %>%"
"0","        group_by(across(all_of(strGroupVars))) %>%"
"0","        summarise(patient_years = sum(total_patient_years))"
"0","    ) %>%"
"0","    mutate("
"0","      Incidence = diagnosed / patient_years * 10000,"
"0","      CI = pois.approx(diagnosed, pt = patient_years) * 10000"
"0","    )"
"0","}"
"0",""
"0","# Function to plot incidence and poission CI"
"0","fPlotIncidence <- function(tblData, strTitle, strGroupBy, strNameGroupBy, numCrudeGlobalIncidence, strSmooth, lstYLim = c(0,100)) {"
"0","  tblData %>% "
"0","  ggplot(aes("
"0","    x = ageband,"
"0","    y = Incidence,"
"0","    group = !!sym(strGroupBy),"
"0","    colour = !!sym(strGroupBy)"
"0","  )) +"
"0","    scale_x_discrete(guide = guide_axis(n.dodge = 2)) +"
"0","    geom_hline(aes(yintercept = numCrudeGlobalIncidence)) +"
"0","    geom_errorbar(aes(ymin = CI$lower, ymax = CI$upper), width = 0.05, alpha = 0.2) +"
"0","    geom_point() +"
"0","    geom_smooth(method = strSmooth, se = FALSE) +"
"0","    ggsci::scale_color_aaas() +"
"0","    theme_cowplot(12) +"
"0","    ylab(""Incidence rate per 10k person years"") +"
"0","    xlab(""Age"") +"
"0","    coord_cartesian(ylim = lstYLim) +"
"0","    labs(colour = strNameGroupBy, title = strTitle)"
"0","}"
"0",""
"0","fPlotBoxIncidence <- function(tblData, strX, strY, strTitle, strGroupBy, boolStaggerXLbl = TRUE, strSmooth, numCrudeGlobalIncidence, lstYLim = c(0,100)) {"
"0","  tblData %>% "
"0","  ggplot(aes("
"0","    x = !!sym(strX),"
"0","    y = !!sym(strY),"
"0","    group = !!sym(strGroupBy),"
"0","    colour = !!sym(strGroupBy)"
"0","  )) +"
"0","    {if(boolStaggerXLbl) scale_x_discrete(guide = guide_axis(n.dodge = 3))} +"
"0","    geom_hline(aes(yintercept = numCrudeGlobalIncidence)) +"
"0","    geom_errorbar(aes(ymin = CI$lower, ymax = CI$upper), width = 0.05, alpha = 0.2, show.legend = FALSE) +"
"0","    geom_boxplot(show.legend = FALSE) +"
"0","    ggsci::scale_color_aaas() +"
"0","    theme_cowplot(12) +"
"0","    ylab(""Incidence rate per 10k person years"") +"
"0","    xlab("""") +"
"0","    coord_cartesian(ylim = lstYLim) +"
"0","    labs(title = strTitle)"
"0","}"
