"0","# Create a parallel processing cluster using available CPU cores"
"0","pllCluster <- new_cluster(parallel::detectCores() - 4)"
"0",""
"0","# Distribute data across the cluster by patient ID"
"0","tblData %>%"
"0","  group_by(pid) %>%"
"0","  partition(pllCluster) -> pllDataSummary"
"0",""
"0","# Load required libraries and functions on all cluster nodes"
"0","cluster_library(pllCluster, ""tidyverse"")"
"0","cluster_copy(pllCluster, c(""fCalcYear"", ""fGetMostFrequent"", ""dateFrom""))"
"0",""
"0","# Summarise data per patient across cluster nodes"
"0","pllDataSummary %>%"
"0","  summarise("
"0","    # If non-unique values exist, get the most frequent values for"
"0","    sex = fGetMostFrequent(sex),"
"0","    qimd = fGetMostFrequent(qimd),"
"0","    ethnicity = fGetMostFrequent(ethnicity),"
"0","    sha = fGetMostFrequent(sha),"
"0","    smoking_status = fGetMostFrequent(smoking_status),"
"0","    dob = fGetMostFrequent(dob),"
"0","    "
"0","    # Check if ever diagnosed with cancer"
"0","    ever_diagnosed = max(is_cancer_relevant),"
"0","    "
"0","    # Check if patient ever died"
"0","    ever_died = max(is_death),"
"0","    "
"0","    # Check if death was cancer-related"
"0","    ever_died_cancer = max(is_death_cancer),"
"0","    "
"0","    # Get earliest date of event for a patient."
"0","    censor_date = min(censor_date)"
"0","  ) %>%"
"0","  "
"0","  # Calculate patient age at event date, rounded down. We need this for age-specific incidence calculations"
"0","  mutate(age = fCalcYear(dob, censor_date) %>% floor()) %>%"
"0","  "
"0","  # Bring results back to the main R session"
"0","  collect() %>%"
"0","  "
"0","  # Remove patients who die of cancer, but are not diagnosed with cancer within available data. These patients would have likely contracted the disease earlier on, and as they already have the disease, they are not at risk. Also only keep events within study interval."
"0","  filter(!(ever_diagnosed == 0 & ever_died_cancer == 1),"
"0","         censor_date %within% intervalStudy) %>% "
"0","  "
"0","  # For some reason, lubridate breaks down when adding years to a leap year...possible bug? Anyway, this should round down the leap day to the previous day. Not an ideal solution, but given the average person-year length of the study, the contribution of a day shouldn't add up that much.. Christ this took ages to figure out whats happening."
"0","  mutate(dob = gsub(""02-29"",""02-28"", dob)) -> tblDataSummary"
"0",""
