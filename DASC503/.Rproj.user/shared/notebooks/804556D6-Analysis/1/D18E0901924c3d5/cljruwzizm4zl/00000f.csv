"0","dateFrom = ymd_hms(""2014-1-1 0:0:1"")
dateTo = ymd_hms(""2020-12-31 23:59:59"")

intervalStudy <- interval(dateFrom,dateTo)

tblData <- read_csv(""Source/pop_snomed_assignment.csv"")
"
"2","[1mRows: [22m[34m476858[39m [1mColumns: [22m[34m10[39m"
"2","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[31mchr[39m  (5): sex, qimd, ethnicity, sha, smoking_status
[32mdbl[39m  (3): pid, medcodeid, snomedctdescriptionid
[34mdate[39m (2): dob, event_date"
"2","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message."
"0","tblLungCancerCodes <- read_csv(""Source/dLungCancerCodes.csv"")"
"2","New names:"
"2","[1mRows: [22m[34m38[39m [1mColumns: [22m[34m13[39m"
"2","[36mâ”€â”€[39m [1mColumn specification[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
[1mDelimiter:[22m "",""
[31mchr[39m (6): read code, disease, descr, category, system, mapping
[32mdbl[39m (7): ...1, medcode, disease_num, system_num, medcodeid, snomedctconceptid, snomedctdes..."
"2","
[36mâ„¹[39m Use `spec()` to retrieve the full column specification for this data.
[36mâ„¹[39m Specify the column types or set `show_col_types = FALSE` to quiet this message."
"0","fGetMostFrequent <- function(tblInput){"
"0","  tblInput %>% "
"0","    table() %>% "
"0","    sort(decreasing = TRUE) %>% "
"0","    .[1] %>% "
"0","    names() -> output"
"0","  return(output)"
"0","}"
"0",""
"0","fCalcYear <- function(dateFrom,dateTo){"
"0","  return(interval(dateFrom, dateTo) / years(1))"
"0","}"
"0",""
"0",""
"0","tblData %<>%"
"0","  filter(!is.na(snomedctdescriptionid)) %>%"
"0","  mutate("
"0","    event_date = ymd(event_date),"
"0","    dob = ymd(dob),"
"0","    qimd = gsub(""1 most deprived"", ""1"", qimd, ignore.case = TRUE),"
"0","    qimd = gsub(""5 least deprived"", ""5"", qimd, ignore.case = TRUE),"
"0","    qimd = as.integer(qimd),"
"0","    is_cancer_relevant = ifelse("
"0","      snomedctdescriptionid %in% tblLungCancerCodes$snomedctdescriptionid |"
"0","      medcodeid %in% tblLungCancerCodes$medcodeid,# |"
"0","     # snomedctdescriptionid == -5, "
"0","     TRUE, FALSE),"
"0","    is_death = ifelse(snomedctdescriptionid < 0, TRUE, FALSE),"
"0","    is_death_cancer = ifelse(snomedctdescriptionid == -5, TRUE, FALSE),"
"0","    censor_date = case_when("
"0","      is_cancer_relevant == TRUE ~ event_date,"
"0","      is_death == TRUE ~ event_date,"
"0","      .default = dateTo"
"0","    )"
"0","  ) "
"0",""
"0","pllCluster <- new_cluster(parallel::detectCores() - 4)"
"0",""
"0","tblData %>%"
"0","  group_by(pid) %>%"
"0","  partition(pllCluster) -> pllDataSummary"
"0",""
"0","cluster_library(pllCluster, ""tidyverse"")"
"0","cluster_copy(pllCluster, c(""fCalcYear"", ""fGetMostFrequent"",""dateFrom""))"
"0",""
"0",""
"0","pllDataSummary %>% "
"0","  summarise("
"0","    sex = fGetMostFrequent(sex),"
"0","    qimd = fGetMostFrequent(qimd),"
"0","    ethnicity = fGetMostFrequent(ethnicity),"
"0","    sha = fGetMostFrequent(sha),"
"0","    smoking_status = fGetMostFrequent(smoking_status),"
"0","    ever_diagnosed = max(is_cancer_relevant),"
"0","    ever_died = max(is_death),"
"0","    ever_died_cancer = max(is_death_cancer),"
"0","    dob = fGetMostFrequent(dob),"
"0","    censor_date = min(censor_date)"
"0","  ) %>% "
"0","  mutate( age = fCalcYear(dob, censor_date) %>% round(0)) %>% "
"0","  collect() %>% "
"0","  filter(!(ever_diagnosed == 0 & ever_died_cancer == 1),#Remove prevalent cancers as they are not at risk"
"0","        censor_date %within% intervalStudy) -> tblDataSummary "
